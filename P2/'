import csv
from random import getrandbits

def complement(bstr):
    res = ""
    for b in bstr:
        res += ('1' if b == '0' else '0')
    return format(int(res, 2) + 1, 'b')

def twos_to_decimal(bstr):
    res = 0
    for i, b in enumerate(bstr):
        pl = ((2**(len(bstr) - 1 - i)) * int(b, 2))
        res += (-pl if i == 0 else pl)
    return res

def decimal_to_twos(num, bits):
    fstr = '0{}b'.format(bits+1)
    res = ''
    if num < 0:
        res = complement(format(abs(num), fstr))
    else:
        res = format(num, fstr)
    return res[(len(res)-bits):]

def add_twos(a, b, bits):
    s = a + b
    overflow = 0
    if s > 2**(bits-1)-1 or s < -2**(bits-1):
        overflow = 1
    return (s, overflow)

def sub_twos(a, b, bits):
    s = a - b
    overflow = 0
    if s > 2**(bits-1)-1 or s < -2**(bits-1):
        overflow = 1
    return (s, overflow)

def leftshift_tests(w, num):
    def f(b, sa):
        a = format(b << sa, '032b')
        if sa != 0:
            return int(a[(len(a)-32):-sa] + (sa * '0'), 2)
        else:
            return int(a[(len(a)-32):], 2)

    for i in range(num):
        b = getrandbits(32)
        sa = getrandbits(5)
        d = f(b, sa)
        write(w, 0, b, 0, sa, '0000000', 0, d, 1)

def leftshift_var_tests(w, num):
    pass

def adder_tests(w, num):
    for i in range(num):
        a = twos_to_decimal(format(getrandbits(32), '032b'))
        b = twos_to_decimal(format(getrandbits(32), '032b'))
        (s, v) = add_twos(a, b, 32)

        w.writerows([(decimal_to_twos(a, 32), decimal_to_twos(b, 32), '0010', '00000', decimal_to_twos(s, 32), v)])

def immediate_arithmetic(w, num):
    # addiu
    for i in range(num):
        a = twos_to_decimal(format(getrandbits(32), '032b'))
        imm = twos_to_decimal(format(getrandbits(32), '032b'))
        (s, v) = add_twos(a, imm, 32)
        write(w, a, 0, 0, 0, '1001001', imm, s, 1)

    # andi, ori, xori, lui
    for i in range(num):
        a = getrandbits(32)
        imm = getrandbits(32)
        c_and = a & imm
        c_or = a | imm
        c_xor = a ^ imm
        write(w, a, 0, 0, 0, '1001100', imm, c_and, s, 1)
        write(w, a, 0, 0, 0, '1001100', imm, c_and, s, 1)
        write(w, a, 0, 0, 0, '1001100', imm, c_and, s, 1)
        # w.writerows([(decimal_to_twos(a, 32), decimal_to_twos(b, 32), '1010', '00000', decimal_to_twos(c_or, 32), 0)])
        # w.writerows([(decimal_to_twos(a, 32), decimal_to_twos(b, 32), '1000', '00000', decimal_to_twos(c_and, 32), 0)])
        # w.writerows([(decimal_to_twos(a, 32), decimal_to_twos(b, 32), '1100', '00000', decimal_to_twos(c_xor, 32), 0)])
        # w.writerows([(decimal_to_twos(a, 32), decimal_to_twos(b, 32), '1110', '00000', c_nor, 0)])

def rightshift_tests(w, num):
    def f(b, sa, arith):
        a = format(b >> sa, '032b')
        if arith and format(b, '032b')[0] == '1':
            i = 0
            while a[i] != '1':
                a = a.replace('0', '1', 1)
                i += 1
        return a

    for i in range(num*2):
        b = getrandbits(32)
        sa = getrandbits(5)
        arith = True if getrandbits(1) == 1 else False
        c = f(b, sa, arith)
        opcode = '0101' if arith else '0100'
        w.writerows([('0'*32, format(b, '032b'), opcode, sa, c, 0)])

def rightshift_var_tests(w, num):
    pass

def subtract_tests(w, num):
    for i in range(num):
        a = twos_to_decimal(format(getrandbits(32), '032b'))
        b = twos_to_decimal(format(getrandbits(32), '032b'))

        (s, v) = sub_twos(a, b, 32)
        w.writerows([(decimal_to_twos(a, 32), decimal_to_twos(b, 32), '0110', '00000', decimal_to_twos(s, 32), v)])

def logic_tests(w, num):
    def flip(n):
        s = ''
        for c in n:
            s += '0' if c == '1' else '1'
        return s

    for i in range(num):
        a = getrandbits(32)
        b = getrandbits(32)
        c_or = a | b
        c_and = a & b
        c_xor = a ^ b
        c_nor = flip(decimal_to_twos(a | b, 32))
        w.writerows([(decimal_to_twos(a, 32), decimal_to_twos(b, 32), '1010', '00000', decimal_to_twos(c_or, 32), 0)])
        w.writerows([(decimal_to_twos(a, 32), decimal_to_twos(b, 32), '1000', '00000', decimal_to_twos(c_and, 32), 0)])
        w.writerows([(decimal_to_twos(a, 32), decimal_to_twos(b, 32), '1100', '00000', decimal_to_twos(c_xor, 32), 0)])
        w.writerows([(decimal_to_twos(a, 32), decimal_to_twos(b, 32), '1110', '00000', c_nor, 0)])

def compare(w, num):
    def ext(b):
        return '0'*31 + ('1' if b else '0')

    for i in range(num):
        a = getrandbits(32)
        b = getrandbits(32)
        w.writerows([(decimal_to_twos(a, 32), decimal_to_twos(b, 32), '1011', '00000', ext(a != b), 0)])
        w.writerows([(decimal_to_twos(a, 32), decimal_to_twos(b, 32), '1001', '00000', ext(a == b), 0)])
        w.writerows([(decimal_to_twos(a, 32), decimal_to_twos(b, 32), '1111', '00000', ext(twos_to_decimal(format(a, '032b')) <= 0), 0)])
        w.writerows([(decimal_to_twos(a, 32), decimal_to_twos(b, 32), '1101', '00000', ext(twos_to_decimal(format(a, '032b')) > 0), 0)])

def write(w, a32, b32, rd5, shamt5, fcn7, imm32, d32, we):
    w.writerows([(a32, b32, rd5, shamt5, fcn7, imm32, d32, 0, rd5, we)])

def main():
    filename = 'execute_tests.txt'

    f = open(filename, 'w')
    writer = csv.writer(f, delimiter = '\t')

    # header
    writer.writerows([('A[32]', 'B[32]', 'rd[5]', 'shamt[5]', 'fcn[7]', 'imm[32]', 'D[32]', 'Bfwd[32]', 'rdo[5]', 'we')])

    immediate_arithmetic(writer, 20)
    leftshift_tests(writer, 20)
    # leftshift_var_tests(writer, 20)
    rightshift_tests(writer, 20)
    # rightshift_var_tests(writer, 20)

    # adder_tests(writer, 200)
    # rightshift_tests(writer, 100)
    # subtract_tests(writer, 200)
    # logic_tests(writer, 50)
    # compare(writer, 50)

    f.close()

if __name__ == '__main__':
    main()
